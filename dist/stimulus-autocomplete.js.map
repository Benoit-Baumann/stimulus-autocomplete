{"version":3,"file":"stimulus-autocomplete.js","sources":["../src/autocomplete.mjs"],"sourcesContent":["import { Controller } from 'stimulus'\nimport debounce from 'lodash.debounce'\n\nexport default class extends Controller {\n  static targets = ['input', 'hidden', 'results']\n\n  connect () {\n    this.resultsTarget.hidden = true\n\n    this.inputTarget.setAttribute('autocomplete', 'off')\n    this.inputTarget.setAttribute('spellcheck', 'false')\n\n    this.mouseDown = false\n\n    this.onInputChange = debounce(this.onInputChange.bind(this), 300)\n    this.onResultsClick = this.onResultsClick.bind(this)\n    this.onResultsMouseDown = this.onResultsMouseDown.bind(this)\n    this.onInputBlur = this.onInputBlur.bind(this)\n    this.onKeydown = this.onKeydown.bind(this)\n\n    this.inputTarget.addEventListener('keydown', this.onKeydown)\n    this.inputTarget.addEventListener('blur', this.onInputBlur)\n    this.inputTarget.addEventListener('input', this.onInputChange)\n    this.resultsTarget.addEventListener('mousedown', this.onResultsMouseDown)\n    this.resultsTarget.addEventListener('click', this.onResultsClick)\n  }\n\n  disconnect () {\n    this.inputTarget.removeEventListener('keydown', this.onKeydown)\n    this.inputTarget.removeEventListener('focus', this.onInputFocus)\n    this.inputTarget.removeEventListener('blur', this.onInputBlur)\n    this.inputTarget.removeEventListener('input', this.onInputChange)\n    this.resultsTarget.removeEventListener('mousedown', this.onResultsMouseDown)\n    this.resultsTarget.removeEventListener('click', this.onResultsClick)\n  }\n\n  sibling (next) {\n    const options = Array.from(this.resultsTarget.querySelectorAll('[role=\"option\"]'))\n    const selected = this.resultsTarget.querySelector('[aria-selected=\"true\"]')\n    const index = options.indexOf(selected)\n    const sibling = next ? options[index + 1] : options[index - 1]\n    const def = next ? options[0] : options[options.length - 1]\n    return sibling || def\n  }\n\n  select (target) {\n    for (const el of this.resultsTarget.querySelectorAll('[aria-selected=\"true\"]')) {\n      el.removeAttribute('aria-selected')\n      el.classList.remove('active')\n    }\n    target.setAttribute('aria-selected', 'true')\n    target.classList.add('active')\n    this.inputTarget.setAttribute('aria-activedescendant', target.id)\n  }\n\n  onKeydown (event) {\n    switch (event.key) {\n      case 'Escape':\n        if (!this.resultsTarget.hidden) {\n          this.hideAndRemoveOptions()\n          event.stopPropagation()\n          event.preventDefault()\n        }\n        break\n      case 'ArrowDown':\n        {\n          const item = this.sibling(true)\n          if (item) this.select(item)\n          event.preventDefault()\n        }\n        break\n      case 'ArrowUp':\n        {\n          const item = this.sibling(false)\n          if (item) this.select(item)\n          event.preventDefault()\n        }\n        break\n      case 'Tab':\n        {\n          const selected = this.resultsTarget.querySelector('[aria-selected=\"true\"]')\n          if (selected) {\n            this.commit(selected)\n          }\n        }\n        break\n      case 'Enter':\n        {\n          const selected = this.resultsTarget.querySelector('[aria-selected=\"true\"]')\n          if (selected && !this.resultsTarget.hidden) {\n            this.commit(selected)\n            event.preventDefault()\n          }\n        }\n        break\n    }\n  }\n\n  onInputBlur () {\n    if (this.mouseDown) return\n    this.resultsTarget.hidden = true\n    if (!this.hiddenTarget.value) this.inputTarget.value = \"\"\n  }\n\n  commit (selected) {\n    if (selected.getAttribute('aria-disabled') === 'true') return\n\n    if (selected instanceof HTMLAnchorElement) {\n      selected.click()\n      this.resultsTarget.hidden = true\n      return\n    }\n\n    const textValue = selected.firstElementChild ? selected.firstElementChild.textContent.trim() : selected.textContent.trim()\n    const value = selected.getAttribute('data-autocomplete-value') || textValue\n    this.inputTarget.value = textValue\n\n    if (this.hasHiddenTarget) {\n      this.hiddenTarget.value = value\n    } else {\n      this.inputTarget.value = value\n    }\n\n    this.inputTarget.focus()\n    this.hideAndRemoveOptions()\n\n    this.element.dispatchEvent(new CustomEvent('autocomplete.change', {\n      bubbles: true,\n      detail: { value: value, textValue: textValue }\n    }))\n  }\n\n  onResultsClick (event) {\n    if (!(event.target instanceof Element)) return\n    const selected = event.target.closest('[role=\"option\"]')\n    if (selected) this.commit(selected)\n  }\n\n  onResultsMouseDown () {\n    this.mouseDown = true\n    this.resultsTarget.addEventListener('mouseup', () => (this.mouseDown = false), { once: true })\n  }\n\n  onInputChange () {\n    this.hiddenTarget.removeAttribute('value')\n    this.fetchResults()\n  }\n\n  identifyOptions () {\n    let id = 0\n    for (const el of this.resultsTarget.querySelectorAll('[role=\"option\"]:not([id])')) {\n      el.id = `${this.resultsTarget.id}-option-${id++}`\n    }\n  }\n\n  hideAndRemoveOptions () {\n    this.resultsTarget.hidden = true\n    this.resultsTarget.innerHTML = null\n  }\n\n  fetchResults () {\n    const query = this.inputTarget.value.trim()\n    if (!query || query.length < this.minLength) {\n      this.hideAndRemoveOptions()\n      return\n    }\n\n    if (!this.src) return\n\n    const url = new URL(this.src, window.location.href)\n    const params = new URLSearchParams(url.search.slice(1))\n    params.append(this.searchKey, query)\n    url.search = params.toString()\n\n    this.element.dispatchEvent(new CustomEvent('loadstart'))\n\n    fetch(url.toString())\n      .then(response => response.text())\n      .then(html => {\n        this.resultsTarget.innerHTML = html\n        this.identifyOptions()\n        const hasResults = !!this.resultsTarget.querySelector('[role=\"option\"]')\n        this.resultsTarget.hidden = !hasResults\n        this.element.dispatchEvent(new CustomEvent('load'))\n        this.element.dispatchEvent(new CustomEvent('loadend'))\n      })\n      .catch(() => {\n        this.element.dispatchEvent(new CustomEvent('error'))\n        this.element.dispatchEvent(new CustomEvent('loadend'))\n      })\n  }\n\n  open () {\n    if (!this.resultsTarget.hidden) return\n    this.resultsTarget.hidden = false\n    this.element.setAttribute('aria-expanded', 'true')\n    this.element.dispatchEvent(new CustomEvent('toggle', { detail: { input: this.input, results: this.results } }))\n  }\n\n  close () {\n    if (this.resultsTarget.hidden) return\n    this.resultsTarget.hidden = true\n    this.inputTarget.removeAttribute('aria-activedescendant')\n    this.element.setAttribute('aria-expanded', 'false')\n    this.element.dispatchEvent(new CustomEvent('toggle', { detail: { input: this.input, results: this.results } }))\n  }\n\n  get src () {\n    return this.data.get(\"url\")\n  }\n\n  get searchKey () {\n    return this.data.get(\"search\") || 'q'\n  }\n\n  get minLength () {\n    const minLength = this.data.get(\"min-length\")\n    if (!minLength) {\n      return 0\n    }\n    return parseInt(minLength, 10)\n  }\n}\n"],"names":["connect","resultsTarget","hidden","inputTarget","setAttribute","mouseDown","onInputChange","debounce","this","bind","onResultsClick","onResultsMouseDown","onInputBlur","onKeydown","addEventListener","disconnect","removeEventListener","onInputFocus","sibling","next","options","Array","from","querySelectorAll","selected","querySelector","index","indexOf","length","select","target","const","el","removeAttribute","classList","remove","add","id","event","key","hideAndRemoveOptions","stopPropagation","preventDefault","item","commit","hiddenTarget","value","getAttribute","HTMLAnchorElement","click","textValue","firstElementChild","textContent","trim","hasHiddenTarget","focus","element","dispatchEvent","CustomEvent","bubbles","detail","Element","closest","once","fetchResults","identifyOptions","innerHTML","query","minLength","src","url","URL","window","location","href","params","URLSearchParams","search","slice","append","searchKey","toString","fetch","then","response","text","html","hasResults","catch","open","input","results","close","data","get","parseInt","Controller","targets"],"mappings":"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"}